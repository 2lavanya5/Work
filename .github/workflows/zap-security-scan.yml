name: OWASP ZAP Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures full repo history for submodules and scanning

      - name: Configure Git Safety
        run: |
          git config --global --add safe.directory /home/runner/work/work/work
          
          # Clean up existing configurations
          git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :
          git submodule foreach --recursive 'git config --local --name-only --get-regexp "core\.sshCommand" && git config --local --unset-all "core.sshCommand" || :'
          
          # Handle HTTP headers cleanup
          git config --local --name-only --get-regexp 'http\.https:\/\/github\.com\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :

      - name: Verify Template Structure
        run: |
          echo "Verifying repository structure..."
          if [ ! -f "requirements.txt" ]; then
            echo "Error: requirements.txt not found!"
            exit 1
          fi
          if [ ! -f "app.py" ]; then
            echo "Error: app.py not found!"
            exit 1
          fi
          echo "Structure check passed."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install gunicorn  # Ensures production-ready server

      - name: Start Flask App
        run: |
          nohup gunicorn -w 4 -b 0.0.0.0:5000 app:app &
          sleep 15  # Wait for app to start

      - name: Run ZAP Scan
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          target: 'http://127.0.0.1:5000'
          cmd_options: '-a'  # Enables all attack modes

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report.html
